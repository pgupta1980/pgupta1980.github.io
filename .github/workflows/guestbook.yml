name: Update Guestbook

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:

jobs:
  update-guestbook:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get guestbook entries
        id: get_entries
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue_number = 1;
            const MAX_ENTRY_LENGTH = 500;

            // Sanitize: strip HTML tags, limit length, escape markdown
            function sanitize(text) {
              let s = text || '';
              // Strip all HTML tags
              s = s.replace(/<[^>]*>/g, '');
              // Remove HTML entities that could be malicious
              s = s.replace(/&(?:lt|gt|amp|quot|apos|#\d+|#x[\da-fA-F]+);?/g, '');
              // Strip markdown headings (prevent fake page structure)
              s = s.replace(/^#{1,6}\s+/gm, '');
              // Strip markdown images (prevent tracking pixels / misleading images)
              s = s.replace(/!\[([^\]]*)\]\([^)]*\)/g, '$1');
              // Strip raw URLs and markdown links to non-github domains
              s = s.replace(/\[([^\]]*)\]\((?!https:\/\/github\.com\/)[^)]*\)/g, '$1');
              // Truncate
              if (s.length > MAX_ENTRY_LENGTH) {
                s = s.substring(0, MAX_ENTRY_LENGTH) + '...';
              }
              return s.trim();
            }

            // Get all comments from the guestbook issue
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              per_page: 100
            });

            // Filter for comments with üëç reaction from repository owner
            const approvedEntries = [];
            for (const comment of comments) {
              const { data: reactions } = await github.rest.reactions.listForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id
              });

              const hasApproval = reactions.some(r =>
                r.content === '+1' && r.user.login === context.repo.owner
              );

              if (hasApproval) {
                approvedEntries.push({
                  body: sanitize(comment.body),
                  author: comment.user.login.replace(/[^a-zA-Z0-9_-]/g, ''),
                  date: comment.created_at
                });
              }
            }

            // Generate markdown for guestbook
            let guestbookContent = '---\n';
            guestbookContent += 'layout: page\n';
            guestbookContent += 'title: Guestbook\n';
            guestbookContent += 'permalink: /guestbook/\n';
            guestbookContent += '---\n\n';
            guestbookContent += '# üìñ Guestbook\n\n';
            guestbookContent += 'Welcome! This is a space for visitors to leave messages and say hello.\n\n';
            guestbookContent += '## How to sign\n\n';
            guestbookContent += '1. [Comment on Issue #1](https://github.com/pgupta1980/pgupta1980.github.io/issues/1) with your message  \n';
            guestbookContent += '2. I\'ll approve it with a üëç reaction  \n';
            guestbookContent += '3. GitHub Actions automatically adds your entry below\n\n';
            guestbookContent += '---\n\n';

            if (approvedEntries.length === 0) {
              guestbookContent += '*No entries yet ‚Äî be the first!*\n';
            } else {
              // Reverse to show newest first
              approvedEntries.reverse().forEach(entry => {
                const date = new Date(entry.date).toLocaleDateString('en-US', {
                  year: 'numeric', month: 'long', day: 'numeric'
                });
                guestbookContent += `### üí¨ ${entry.author} ‚Äî ${date}\n\n`;
                guestbookContent += `${entry.body}\n\n`;
                guestbookContent += `‚Äî [@${entry.author}](https://github.com/${entry.author})\n\n`;
                guestbookContent += '---\n\n';
              });
            }

            fs.writeFileSync('guestbook.md', guestbookContent);
            console.log(`Updated guestbook with ${approvedEntries.length} entries`);

      - name: Commit and push changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add guestbook.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "‚úèÔ∏è Update guestbook"
            git push
          fi
